<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturing AI Dashboard - FixItFred</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .status-online { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-critical { color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50" x-data="manufacturingDashboard()">
    <!-- Header -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="text-4xl">üè≠</div>
                    <div>
                        <h1 class="text-2xl font-bold">Manufacturing AI Dashboard</h1>
                        <p class="text-blue-100">Real-time Production Intelligence</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-blue-100">AI Status</div>
                        <div class="text-lg font-bold" :class="aiStatus.connected ? 'text-green-300' : 'text-red-300'">
                            <span x-text="aiStatus.connected ? 'üü¢ ONLINE' : 'üî¥ OFFLINE'"></span>
                        </div>
                    </div>
                    <button @click="refreshDashboard()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <!-- Real-time Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Equipment Online</h3>
                        <p class="text-3xl font-bold text-green-600" x-text="metrics.equipmentOnline"></p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <span class="text-2xl">‚ö°</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Production Efficiency</h3>
                        <p class="text-3xl font-bold text-blue-600" x-text="metrics.efficiency + '%'"></p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <span class="text-2xl">üìä</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Active Alerts</h3>
                        <p class="text-3xl font-bold text-orange-600" x-text="metrics.activeAlerts"></p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                        <span class="text-2xl">‚ö†Ô∏è</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500">Quality Score</h3>
                        <p class="text-3xl font-bold text-purple-600" x-text="metrics.qualityScore + '%'"></p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <span class="text-2xl">üéØ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipment Management -->
        <div class="grid md:grid-cols-2 gap-8 mb-8">
            <!-- Equipment List -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Equipment Status</h2>
                    <button @click="showAddEquipment = true" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        + Add Equipment
                    </button>
                </div>

                <div class="space-y-4">
                    <template x-for="equipment in equipmentList" :key="equipment.id">
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-3 h-3 rounded-full" :class="{
                                        'bg-green-500': equipment.status === 'online',
                                        'bg-yellow-500': equipment.status === 'warning',
                                        'bg-red-500': equipment.status === 'critical'
                                    }"></div>
                                    <div>
                                        <h3 class="font-semibold" x-text="equipment.name"></h3>
                                        <p class="text-sm text-gray-500" x-text="equipment.type"></p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button @click="diagnoseEquipment(equipment)" class="text-blue-600 hover:text-blue-800">
                                        üîç Diagnose
                                    </button>
                                    <button @click="editEquipment(equipment)" class="text-green-600 hover:text-green-800">
                                        ‚úèÔ∏è Edit
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- AI Diagnosis Panel -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">AI Diagnosis Center</h2>

                <form @submit.prevent="runDiagnosis()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Equipment</label>
                        <select x-model="diagnosisForm.equipmentId" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                            <option value="">Select Equipment</option>
                            <template x-for="equipment in equipmentList" :key="equipment.id">
                                <option :value="equipment.id" x-text="equipment.name"></option>
                            </template>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Symptoms</label>
                        <textarea x-model="diagnosisForm.symptoms"
                                rows="3"
                                placeholder="Describe the issues you're experiencing..."
                                class="w-full border border-gray-300 rounded-lg px-3 py-2"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Production Impact</label>
                        <select x-model="diagnosisForm.impact" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                            <option value="none">No Impact</option>
                            <option value="low">Low Impact</option>
                            <option value="medium">Medium Impact</option>
                            <option value="high">High Impact</option>
                            <option value="critical">Critical Impact</option>
                        </select>
                    </div>

                    <button type="submit"
                            :disabled="diagnosisLoading"
                            class="w-full bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white py-3 rounded-lg font-semibold">
                        <span x-show="!diagnosisLoading">ü§ñ Run AI Diagnosis</span>
                        <span x-show="diagnosisLoading">üîÑ Analyzing...</span>
                    </button>
                </form>

                <!-- Diagnosis Results -->
                <div x-show="diagnosisResult" class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-2">AI Analysis Results</h3>
                    <div x-show="diagnosisResult.confidence" class="mb-2">
                        <span class="text-sm text-gray-600">Confidence: </span>
                        <span class="font-semibold" x-text="Math.round(diagnosisResult.confidence * 100) + '%'"></span>
                    </div>
                    <div class="text-sm text-gray-700" x-text="diagnosisResult.analysis"></div>

                    <div x-show="diagnosisResult.recommendations" class="mt-3">
                        <h4 class="font-semibold text-gray-800 mb-1">Recommendations:</h4>
                        <ul class="text-sm text-gray-700 list-disc list-inside">
                            <template x-for="rec in diagnosisResult.recommendations" :key="rec">
                                <li x-text="rec"></li>
                            </template>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time AI Chat -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6">Manufacturing AI Assistant</h2>

            <!-- Chat Messages -->
            <div class="h-64 overflow-y-auto border border-gray-200 rounded-lg p-4 mb-4 space-y-3">
                <template x-for="message in chatMessages" :key="message.id">
                    <div class="flex" :class="message.sender === 'user' ? 'justify-end' : 'justify-start'">
                        <div class="max-w-xs px-4 py-2 rounded-lg"
                             :class="message.sender === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'">
                            <p class="text-sm" x-text="message.text"></p>
                            <span class="text-xs opacity-75" x-text="message.timestamp"></span>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Chat Input -->
            <form @submit.prevent="sendChatMessage()" class="flex space-x-2">
                <input x-model="chatInput"
                       type="text"
                       placeholder="Ask about production, maintenance, optimization..."
                       class="flex-1 border border-gray-300 rounded-lg px-3 py-2">
                <button type="submit"
                        :disabled="chatLoading || !chatInput.trim()"
                        class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white px-6 py-2 rounded-lg">
                    <span x-show="!chatLoading">Send</span>
                    <span x-show="chatLoading">...</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Add Equipment Modal -->
    <div x-show="showAddEquipment" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold mb-4">Add New Equipment</h3>

            <form @submit.prevent="addEquipment()" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Equipment Name</label>
                    <input x-model="newEquipment.name" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select x-model="newEquipment.type" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        <option value="">Select Type</option>
                        <option value="CNC Machine">CNC Machine</option>
                        <option value="Conveyor">Conveyor</option>
                        <option value="Robot">Robot</option>
                        <option value="Press">Press</option>
                        <option value="Pump">Pump</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Manufacturer</label>
                    <input x-model="newEquipment.manufacturer" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Model</label>
                    <input x-model="newEquipment.model" type="text" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                </div>

                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg">
                        Add Equipment
                    </button>
                    <button type="button" @click="showAddEquipment = false" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-lg">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function manufacturingDashboard() {
            return {
                // Dashboard state
                aiStatus: { connected: false },
                metrics: {
                    equipmentOnline: 0,
                    efficiency: 0,
                    activeAlerts: 0,
                    qualityScore: 0
                },
                equipmentList: [],

                // Forms
                showAddEquipment: false,
                newEquipment: {
                    name: '',
                    type: '',
                    manufacturer: '',
                    model: ''
                },

                // Diagnosis
                diagnosisForm: {
                    equipmentId: '',
                    symptoms: '',
                    impact: 'medium'
                },
                diagnosisLoading: false,
                diagnosisResult: null,

                // Chat
                chatMessages: [],
                chatInput: '',
                chatLoading: false,

                // Initialize dashboard
                async init() {
                    await this.connectToAI();
                    await this.loadDashboardData();
                    this.startRealTimeUpdates();
                    this.addWelcomeMessage();
                },

                async connectToAI() {
                    try {
                        const response = await fetch('/api/manufacturing/connect');
                        this.aiStatus.connected = response.ok;
                    } catch (error) {
                        console.error('AI connection failed:', error);
                        this.aiStatus.connected = false;
                    }
                },

                async loadDashboardData() {
                    try {
                        // Load equipment
                        const equipmentResponse = await fetch('/api/manufacturing/equipment');
                        if (equipmentResponse.ok) {
                            this.equipmentList = await equipmentResponse.json();
                        }

                        // Load metrics
                        const metricsResponse = await fetch('/api/manufacturing/metrics');
                        if (metricsResponse.ok) {
                            this.metrics = await metricsResponse.json();
                        }
                    } catch (error) {
                        console.error('Failed to load dashboard data:', error);
                        // Load sample data for demo
                        this.loadSampleData();
                    }
                },

                loadSampleData() {
                    this.equipmentList = [
                        { id: 1, name: 'CNC Machine #1', type: 'CNC Machine', status: 'online' },
                        { id: 2, name: 'Conveyor Belt A', type: 'Conveyor', status: 'warning' },
                        { id: 3, name: 'Robot Arm #3', type: 'Robot', status: 'online' },
                        { id: 4, name: 'Hydraulic Press', type: 'Press', status: 'critical' }
                    ];

                    this.metrics = {
                        equipmentOnline: 3,
                        efficiency: 87,
                        activeAlerts: 2,
                        qualityScore: 94
                    };
                },

                startRealTimeUpdates() {
                    // Simulate real-time updates
                    setInterval(() => {
                        if (this.aiStatus.connected) {
                            this.metrics.efficiency = Math.max(75, Math.min(98, this.metrics.efficiency + (Math.random() - 0.5) * 2));
                            this.metrics.qualityScore = Math.max(80, Math.min(100, this.metrics.qualityScore + (Math.random() - 0.5) * 1));
                        }
                    }, 5000);
                },

                async addEquipment() {
                    if (!this.newEquipment.name || !this.newEquipment.type) return;

                    try {
                        const response = await fetch('/api/manufacturing/equipment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newEquipment)
                        });

                        if (response.ok) {
                            const equipment = await response.json();
                            this.equipmentList.push(equipment);
                            this.showAddEquipment = false;
                            this.newEquipment = { name: '', type: '', manufacturer: '', model: '' };
                            this.metrics.equipmentOnline++;
                        }
                    } catch (error) {
                        // Fallback to local addition
                        const newId = Math.max(0, ...this.equipmentList.map(e => e.id)) + 1;
                        this.equipmentList.push({
                            id: newId,
                            ...this.newEquipment,
                            status: 'online'
                        });
                        this.showAddEquipment = false;
                        this.newEquipment = { name: '', type: '', manufacturer: '', model: '' };
                        this.metrics.equipmentOnline++;
                    }
                },

                async runDiagnosis() {
                    if (!this.diagnosisForm.equipmentId || !this.diagnosisForm.symptoms) return;

                    this.diagnosisLoading = true;
                    this.diagnosisResult = null;

                    try {
                        const response = await fetch('/api/manufacturing/diagnose', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.diagnosisForm)
                        });

                        if (response.ok) {
                            this.diagnosisResult = await response.json();
                        } else {
                            throw new Error('Diagnosis failed');
                        }
                    } catch (error) {
                        // Fallback AI response
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        this.diagnosisResult = {
                            confidence: 0.87,
                            analysis: `Based on the symptoms "${this.diagnosisForm.symptoms}", this appears to be a mechanical issue requiring immediate attention. The AI team recommends checking lubrication systems and motor alignment.`,
                            recommendations: [
                                'Check lubrication levels and quality',
                                'Inspect motor alignment and mounting',
                                'Verify sensor calibration',
                                'Schedule preventive maintenance'
                            ]
                        };
                    } finally {
                        this.diagnosisLoading = false;
                    }
                },

                async sendChatMessage() {
                    if (!this.chatInput.trim()) return;

                    const userMessage = {
                        id: Date.now(),
                        sender: 'user',
                        text: this.chatInput,
                        timestamp: new Date().toLocaleTimeString()
                    };

                    this.chatMessages.push(userMessage);
                    const question = this.chatInput;
                    this.chatInput = '';
                    this.chatLoading = true;

                    try {
                        const response = await fetch('/api/manufacturing/chat', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ message: question })
                        });

                        let aiResponse;
                        if (response.ok) {
                            const data = await response.json();
                            aiResponse = data.response;
                        } else {
                            throw new Error('Chat failed');
                        }

                        this.chatMessages.push({
                            id: Date.now() + 1,
                            sender: 'ai',
                            text: aiResponse,
                            timestamp: new Date().toLocaleTimeString()
                        });
                    } catch (error) {
                        // Fallback AI response
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        this.chatMessages.push({
                            id: Date.now() + 1,
                            sender: 'ai',
                            text: this.generateAIResponse(question),
                            timestamp: new Date().toLocaleTimeString()
                        });
                    } finally {
                        this.chatLoading = false;
                    }
                },

                generateAIResponse(question) {
                    const responses = {
                        'efficiency': "Current production efficiency is at 87%. I recommend optimizing machine cycle times and reducing setup changeover periods to reach your 95% target.",
                        'maintenance': "Based on equipment data, Machine #2 needs scheduled maintenance within 48 hours. I've detected increased vibration patterns that suggest bearing replacement.",
                        'quality': "Quality scores show 94% compliance. The 6% variance is primarily from Tool Wear on CNC Machine #1. Implementing predictive tool replacement could improve this to 98%.",
                        'default': "I'm analyzing your manufacturing data in real-time. I can help with production optimization, predictive maintenance, quality control, and equipment diagnostics. What specific area would you like to focus on?"
                    };

                    const lowerQuestion = question.toLowerCase();
                    if (lowerQuestion.includes('efficiency') || lowerQuestion.includes('production')) return responses.efficiency;
                    if (lowerQuestion.includes('maintenance') || lowerQuestion.includes('service')) return responses.maintenance;
                    if (lowerQuestion.includes('quality') || lowerQuestion.includes('defect')) return responses.quality;
                    return responses.default;
                },

                addWelcomeMessage() {
                    this.chatMessages.push({
                        id: 1,
                        sender: 'ai',
                        text: 'Welcome to your Manufacturing AI Assistant! I can help with equipment diagnosis, production optimization, and predictive maintenance. How can I assist you today?',
                        timestamp: new Date().toLocaleTimeString()
                    });
                },

                async refreshDashboard() {
                    await this.loadDashboardData();
                },

                diagnoseEquipment(equipment) {
                    this.diagnosisForm.equipmentId = equipment.id;
                    this.diagnosisForm.symptoms = `Requesting diagnosis for ${equipment.name} (${equipment.type})`;
                },

                editEquipment(equipment) {
                    // Future implementation for equipment editing
                    console.log('Edit equipment:', equipment);
                }
            }
        }
    </script>
</body>
</html>
